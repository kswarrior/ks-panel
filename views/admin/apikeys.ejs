<%- include('../components/template') %>

<main id="content">
  <div class="bg-transparent">
    <div class="sm:flex sm:items-center px-8 pt-4">
      <div class="sm:flex-auto">
        <h1 class="text-base font-medium leading-6 text-white">
          <%= req.translations.APIKeys %>
        </h1>
        <p class="mt-1 tracking-tight text-sm text-neutral-500">
          <%= req.translations.APIKeysText %>
        </p>
      </div>
      <div class="mt-4 sm:ml-16 sm:mt-0 sm:flex-none">
        <button
          id="createButton"
          type="button"
          class="block rounded-xl <%= theme['button-color'] %> px-3 py-2 text-center text-sm font-medium shadow-lg transition focus:outline focus:outline-2 focus:outline-offset-2"
        >
          <%= req.translations.createNewAPIKey %>
        </button>
      </div>
    </div>

    <% if (req.query.err === "CREATED") { %>
      <div class="mt-6 w-full">
        <div class="rounded-xl bg-emerald-800/10 px-4 py-6 mt-8 ml-8 mb-8 mr-8">
          <div class="flex">
            <div class="flex-shrink-0 ml-1.5">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" class="w-5 h-5 mt-2 text-emerald-400">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 0 1 .143 1.052l-8 10.5a.75.75 0 0 1-1.127.075l-4.5-4.5a.75.75 0 0 1 1.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 0 1 1.05-.143Z" clip-rule="evenodd" />
              </svg>
            </div>
            <div class="ml-5">
              <h3 class="text-sm font-medium text-emerald-400">
                <%= req.translations.created %>
              </h3>
              <div class="text-sm text-emerald-400/50">
                <p><%= req.translations.apiKeySuccessCreated %></p>
              </div>
            </div>
          </div>
        </div>
      </div>
    <% } %>

    <div id="nodeTable" class="mt-6 w-full">
      <table class="mt-6 w-full whitespace-nowrap text-left">
        <colgroup>
          <col class="w-full sm:w-4/12" />
          <col class="lg:w-4/12" />
          <col class="lg:w-2/12" />
          <col class="lg:w-2/12" />
        </colgroup>
        <thead class="border-b border-white/5 text-sm leading-6 text-white">
          <tr>
            <th scope="col" class="py-2 pl-4 pr-8 font-medium sm:pl-8 lg:pl-8">
              <%= req.translations.id %>
            </th>
            <th scope="col" class="py-2 pl-0 pr-8 font-medium sm:table-cell">
              <%= req.translations.key %>
            </th>
            <th scope="col" class="py-2 pl-0 pr-8 font-medium md:table-cell lg:pr-20">
              <%= req.translations.createdAt %>
            </th>
            <th scope="col" class="py-2 pl-0 pr-8 font-medium md:table-cell lg:pr-20">
              <%= req.translations.actions %>
            </th>
          </tr>
        </thead>
        <tbody id="apiKeyBody" class="divide-y divide-white/5">
          <% if (apiKeys.length === 0) { %>
            <tr id="noKeysRow">
              <td colspan="4" class="py-4 text-center text-neutral-400">
                <%= req.translations.noApiKeysCreated %>
              </td>
            </tr>
          <% } %>

          <% apiKeys.forEach(function(key) { %>
            <tr id="row-<%= key.id %>">
              <td class="py-4 pl-4 pr-8 sm:pl-8 lg:pl-8">
                <div class="truncate text-sm font-medium leading-6 text-white">
                  <%= key.id %>
                </div>
              </td>
              <td class="hidden py-4 pl-0 pr-4 sm:table-cell sm:pr-8">
                <div class="rounded-xl font-mono bg-neutral-800/40 px-2 py-1 text-xs font-medium text-neutral-400 ring-1 ring-inset ring-white/10">
                  <%= key.key %>
                </div>
              </td>
              <td class="hidden py-4 pl-0 pr-4 sm:table-cell sm:pr-8">
                <div class="rounded-xl bg-neutral-800/40 px-2 py-1 text-xs font-medium text-neutral-400 ring-1 ring-inset ring-white/10">
                  <%= key.createdAt %>
                </div>
              </td>
              <td class="py-4 pl-0 pr-4 text-sm leading-6 sm:pr-8 lg:pr-20 flex gap-3">
                <button
                  type="button"
                  class="removeButton block rounded-xl bg-red-600 px-3 py-2 text-center text-sm font-medium text-white shadow-lg hover:bg-red-500 transition"
                  data-keyid="<%= key.id %>"
                >
                  <%= req.translations.remove %>
                </button>
              </td>
            </tr>
          <% }); %>
        </tbody>
      </table>
    </div>

    <%- include('../components/pagination', { pagination }) %>

    <div id="nodeForm" class="mt-6 px-8 w-full hidden">
      <form>
        <button
          id="createNodeBtn"
          type="button"
          class="block rounded-xl <%= theme['button-color'] %> px-3 py-2 text-center text-sm font-medium shadow-lg transition focus:outline focus:outline-2 focus:outline-offset-2"
        >
          <%= req.translations.clickToConfirmCreation %>
        </button>
      </form>
    </div>
  </div>
</main>

<script>
  const table = document.getElementById("nodeTable");
  const form = document.getElementById("nodeForm");
  const createButton = document.getElementById("createButton");
  const createNodeBtn = document.getElementById("createNodeBtn");
  const apiKeyBody = document.getElementById("apiKeyBody");

  createButton.addEventListener("click", () => {
    table.classList.toggle("hidden");
    form.classList.toggle("hidden");
  });

  createNodeBtn.addEventListener("click", async () => {
    createNodeBtn.disabled = true;

    try {
      const response = await fetch("/apikeys/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) throw new Error("Create failed");

      const data = await response.json();

      document.getElementById("noKeysRow")?.remove();

      const row = document.createElement("tr");
      row.id = "row-" + data.id;
      row.innerHTML = `
        <td class="py-4 pl-4 pr-8 sm:pl-8 lg:pl-8">
          <div class="truncate text-sm font-medium leading-6 text-white">${data.id}</div>
        </td>
        <td class="hidden py-4 pl-0 pr-4 sm:table-cell sm:pr-8">
          <div class="rounded-xl font-mono bg-neutral-800/40 px-2 py-1 text-xs font-medium text-neutral-400 ring-1 ring-inset ring-white/10">
            ${data.key}
          </div>
        </td>
        <td class="hidden py-4 pl-0 pr-4 sm:table-cell sm:pr-8">
          <div class="rounded-xl bg-neutral-800/40 px-2 py-1 text-xs font-medium text-neutral-400 ring-1 ring-inset ring-white/10">
            ${data.createdAt}
          </div>
        </td>
        <td class="py-4 pl-0 pr-4 text-sm leading-6 sm:pr-8 lg:pr-20 flex gap-3">
          <button
            type="button"
            class="removeButton block rounded-xl bg-red-600 px-3 py-2 text-center text-sm font-medium text-white shadow-lg hover:bg-red-500 transition"
            data-keyid="${data.id}"
          >
            <%= req.translations.remove %>
          </button>
        </td>
      `;

      apiKeyBody.prepend(row);
      attachRemoveHandler(row.querySelector(".removeButton"));

      table.classList.remove("hidden");
      form.classList.add("hidden");

    } catch (err) {
      alert('<%= req.translations.apiKeyErrorCreated %>');
    } finally {
      createNodeBtn.disabled = false;
    }
  });

  function attachRemoveHandler(button) {
    button.addEventListener("click", async function () {
      const keyId = this.dataset.keyid;
      const row = document.getElementById("row-" + keyId);

      row.classList.add("opacity-50");

      try {
        const response = await fetch("/apikeys/delete", {
          method: "DELETE",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ keyId })
        });

        if (!response.ok) throw new Error("Delete failed");

        row.remove();

        if (apiKeyBody.children.length === 0) {
          apiKeyBody.innerHTML = `
            <tr id="noKeysRow">
              <td colspan="4" class="py-4 text-center text-neutral-400">
                <%= req.translations.noApiKeysCreated %>
              </td>
            </tr>
          `;
        }

      } catch (err) {
        row.classList.remove("opacity-50");
        alert('<%= req.translations.apiKeyErrorDelete %>');
      }
    });
  }

  document.querySelectorAll(".removeButton").forEach(attachRemoveHandler);
</script>

<%- include('../components/footer') %>
