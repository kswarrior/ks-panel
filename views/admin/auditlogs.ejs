<%- include('../components/template') %>

<main id="content" class="min-h-screen pb-10">

  <div class="px-8 pt-6">
    <h1 class="text-2xl font-semibold text-white tracking-tight">
      <%= req.translations.auditLogs %>
    </h1>
    <p class="mt-2 text-sm text-neutral-400">
      <%= req.translations.auditLogsText %>
    </p>
  </div>

  <div class="px-8 mt-6">
    <div class="bg-white/5 border border-white/10 rounded-2xl p-6 shadow-lg backdrop-blur-md">
      <div class="flex flex-wrap items-center gap-6">

        <div class="flex items-center gap-3">
          <label for="actionFilter" class="text-sm text-neutral-300">
            <%= req.translations.filterByAction || 'Filter by Action:' %>
          </label>
          <select id="actionFilter"
            class="bg-white/5 border border-white/10 text-white rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="" class="text-neutral-800"
              <%= !filters.actionFilter ? 'selected' : '' %>>
              <%= req.translations.allActions || 'All Actions' %>
            </option>
            <% actions.forEach(action => { %>
              <option value="<%= action %>" class="text-neutral-800"
                <%= filters.actionFilter === action ? 'selected' : '' %>>
                <%= action %>
              </option>
            <% }); %>
          </select>
        </div>

        <div class="flex items-center gap-3">
          <label for="dateRange" class="text-sm text-neutral-300">
            <%= req.translations.dateRange || 'Date Range:' %>
          </label>
          <select id="dateRange"
            class="bg-white/5 border border-white/10 text-white rounded-xl px-4 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 transition">
            <option value="2" <%= filters.dateRange == 2 ? 'selected' : '' %>>
              <%= req.translations.last2Days || 'Last 2 Days' %>
            </option>
            <option value="7" <%= filters.dateRange == 7 ? 'selected' : '' %>>
              <%= req.translations.lastWeek || 'Last Week' %>
            </option>
            <option value="30" <%= filters.dateRange == 30 ? 'selected' : '' %>>
              <%= req.translations.lastMonth || 'Last Month' %>
            </option>
            <option value="" <%= !filters.dateRange ? 'selected' : '' %>>
              <%= req.translations.allTime || 'All Time' %>
            </option>
          </select>
        </div>

        <div class="flex items-center gap-3">
          <button id="sortAsc"
            class="rounded-xl bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700 transition shadow-md">
            ↑
          </button>
          <button id="sortDesc"
            class="rounded-xl bg-blue-600 px-4 py-2 text-sm text-white hover:bg-blue-700 transition shadow-md">
            ↓
          </button>
        </div>

      </div>
    </div>
  </div>

  <div class="px-8 mt-8">
    <% if (audits && audits.length > 0) { %>

      <div class="overflow-x-auto rounded-2xl border border-white/10 bg-white/5 backdrop-blur-md shadow-lg">
        <table id="auditTable" class="min-w-full divide-y divide-white/10">

          <thead class="bg-white/5">
            <tr>
              <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-300 uppercase">
                <%= req.translations.user %>
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-300 uppercase">
                <%= req.translations.action %>
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-300 uppercase">
                <%= req.translations.addressIP %>
              </th>
              <th class="px-6 py-4 text-left text-xs font-semibold text-neutral-300 uppercase">
                <%= req.translations.timestamp %>
              </th>
            </tr>
          </thead>

          <tbody id="auditBody" class="divide-y divide-white/5">
            <% audits.forEach(function(audit) { %>
              <tr class="hover:bg-white/5 transition"
                  data-timestamp="<%= new Date(audit.timestamp).getTime() %>">

                <td class="px-6 py-4 text-sm text-white font-medium">
                  <% if (audit.userId === req.user.userId) { %>
                    <%= req.translations.you %>
                    <span class="text-neutral-400">(<%= audit.userId %>)</span>
                  <% } else { %>
                    <%= audit.username %>
                    <span class="text-neutral-400">(<%= audit.userId %>)</span>
                  <% } %>
                </td>

                <td class="px-6 py-4 text-sm text-neutral-400">
                  <%= audit.action %>
                </td>

                <td class="px-6 py-4 text-sm text-neutral-400">
                  <%= audit.ip %>
                </td>

                <td class="px-6 py-4 text-sm text-neutral-400">
                  <%= new Date(audit.timestamp).toLocaleString() %>
                </td>

              </tr>
            <% }); %>
          </tbody>

        </table>
      </div>

    <% } else { %>

      <div class="mt-6 text-neutral-500 text-sm">
        <%= req.translations.auditLogsNotAvailable %>
      </div>

    <% } %>
  </div>

  <div class="px-8 mt-6">
    <%- include('../components/pagination', {
      pagination,
      filters: {
        action: filters.actionFilter,
        dateRange: filters.dateRange
      }
    }) %>
  </div>

</main>

<%- include('../components/footer') %>

<script>
document.addEventListener('DOMContentLoaded', function () {

  const actionFilter = document.getElementById('actionFilter');
  const dateRange = document.getElementById('dateRange');
  const sortAsc = document.getElementById('sortAsc');
  const sortDesc = document.getElementById('sortDesc');
  const tableBody = document.getElementById('auditBody');

  function navigateWithFilters(page = 1) {
    const params = new URLSearchParams();
    params.set('page', page);

    if (actionFilter && actionFilter.value)
      params.set('action', actionFilter.value);

    if (dateRange && dateRange.value)
      params.set('dateRange', dateRange.value);

    window.location.href = '/admin/auditlogs?' + params.toString();
  }

  function sortTable(ascending) {
    if (!tableBody) return;

    const rows = Array.from(tableBody.querySelectorAll('tr'));

    rows.sort((a, b) => {
      const tA = parseInt(a.dataset.timestamp);
      const tB = parseInt(b.dataset.timestamp);
      return ascending ? tA - tB : tB - tA;
    });

    tableBody.innerHTML = '';
    rows.forEach(row => tableBody.appendChild(row));
  }

  if (actionFilter)
    actionFilter.addEventListener('change', () => navigateWithFilters(1));

  if (dateRange)
    dateRange.addEventListener('change', () => navigateWithFilters(1));

  if (sortAsc)
    sortAsc.addEventListener('click', () => sortTable(true));

  if (sortDesc)
    sortDesc.addEventListener('click', () => sortTable(false));

  window.navigateWithFilters = navigateWithFilters;

});
</script>
