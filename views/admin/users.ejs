<%- include('../components/template') %>
<main id="content" class="px-4 sm:px-6 lg:px-8 py-6">

  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-lg font-semibold text-white">
        <%= req.translations.users %>
      </h1>
      <p class="mt-1 text-sm text-neutral-400">
        <%= req.translations.usersDescription %>
      </p>
    </div>

    <button
      id="createButton"
      type="button"
      class="rounded-xl <%= theme['button-color'] %> px-4 py-2 text-sm font-medium shadow transition"
    >
      <%= req.translations.createUserButton %>
    </button>
  </div>


  <!-- Table Wrapper -->
  <div id="nodeTable" class="mt-6 w-full overflow-x-auto">

    <table class="min-w-full text-sm text-left text-white border-collapse">

      <!-- Table Head -->
      <thead class="border-b border-white/10 text-neutral-400">
        <tr>
          <th class="py-3 px-4 font-medium">
            <%= req.translations.name %>
          </th>
          <th class="py-3 px-4 font-medium">
            <%= req.translations.email %>
          </th>
          <th class="py-3 px-4 font-medium">
            <%= req.translations.information %>
          </th>
          <th class="py-3 px-4 font-medium">
            <%= req.translations.role %>
          </th>
          <th class="py-3 px-4 font-medium">
            <%= req.translations.verificationStatus %>
          </th>
          <th class="py-3 px-4 font-medium text-right">
            <%= req.translations.actions %>
          </th>
        </tr>
      </thead>

      <!-- Table Body -->
      <tbody class="divide-y divide-white/5">

        <% users.forEach(function(user) { %>
        <tr class="hover:bg-white/5 transition">

          <!-- Name -->
          <td class="py-4 px-4">
            <div class="flex items-center gap-3 min-w-[180px]">
              <img
                class="h-8 w-8 rounded-lg"
                src="https://api.dicebear.com/9.x/thumbs/svg?seed=<%= user.username %>"
                alt=""
              />
              <span class="truncate font-medium">
                <%= user.username %>
              </span>
            </div>
          </td>

          <!-- Email -->
          <td class="py-4 px-4 min-w-[220px]">
            <div class="bg-neutral-800/40 px-3 py-1 rounded-lg text-xs text-neutral-300 truncate">
              <%= user.email %>
            </div>
          </td>

          <!-- User ID -->
          <td class="py-4 px-4 min-w-[150px]">
            <div class="bg-neutral-800/40 px-3 py-1 rounded-lg text-xs text-neutral-300 truncate">
              <%= user.userId %>
            </div>
          </td>

          <!-- Role -->
          <td class="py-4 px-4">
            <% if (user.admin==true) { %>
              <span class="text-indigo-400 text-sm">
                <%= req.translations.admin %>
              </span>
            <% } else { %>
              <span class="text-neutral-400 text-sm">
                <%= req.translations.regularUserRole %>
              </span>
            <% } %>
          </td>

          <!-- Verification -->
          <td class="py-4 px-4">
            <% if (user.verified==true) { %>
              <span class="text-green-500 text-sm">
                <%= req.translations.verifiedStatus %>
              </span>
            <% } else { %>
              <span class="text-red-500 text-sm">
                <%= req.translations.unverifiedStatus %>
              </span>
            <% } %>
          </td>

          <!-- Actions -->
          <td class="py-4 px-4">
            <div class="flex justify-end gap-2 min-w-[160px]">

              <a href="/admin/users/edit/<%= user.userId %>">
                <button
                  type="button"
                  class="rounded-lg <%= theme['button-color'] %> px-3 py-1.5 text-xs font-medium shadow transition"
                >
                  <%= req.translations.edit %>
                </button>
              </a>

              <button
                type="button"
                class="removeButton rounded-lg bg-red-600 hover:bg-red-500 px-3 py-1.5 text-xs font-medium text-white shadow transition"
                data-user-id="<%= user.userId %>"
              >
                <%= req.translations.remove %>
              </button>

            </div>
          </td>

        </tr>
        <% }); %>

      </tbody>
    </table>
  </div>


  <!-- Create User Form -->
  <div id="nodeForm" class="mt-8 hidden">

    <div class="max-w-2xl space-y-5">

      <div>
        <label class="block text-sm text-neutral-400 mb-2">
          <%= req.translations.username %>
        </label>
        <input
          id="userName"
          type="text"
          name="username"
          class="w-full rounded-xl bg-neutral-800/40 border border-white/10 px-4 py-2 text-sm text-white focus:outline-none"
          placeholder="<%= req.translations.usernamePlaceholder %>"
        />
      </div>

      <div>
        <label class="block text-sm text-neutral-400 mb-2">
          <%= req.translations.email %>
        </label>
        <input
          id="email"
          type="email"
          name="email"
          class="w-full rounded-xl bg-neutral-800/40 border border-white/10 px-4 py-2 text-sm text-white focus:outline-none"
          placeholder="<%= req.translations.emailPlaceholder %>"
        />
      </div>

      <div>
        <label class="block text-sm text-neutral-400 mb-2">
          <%= req.translations.passwordLabel %>
        </label>
        <input
          id="userPass"
          type="password"
          name="password"
          class="w-full rounded-xl bg-neutral-800/40 border border-white/10 px-4 py-2 text-sm text-white focus:outline-none"
          placeholder="******"
        />
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">

        <div>
          <label class="block text-sm text-neutral-400 mb-2">
            <%= req.translations.admin %>
          </label>
          <select
            id="userAdmin"
            name="admin"
            class="w-full rounded-xl bg-neutral-800/40 border border-white/10 px-4 py-2 text-sm text-white focus:outline-none"
          >
            <option value="true"><%= req.translations.true %></option>
            <option value="false"><%= req.translations.false %></option>
          </select>
        </div>

        <div>
          <label class="block text-sm text-neutral-400 mb-2">
            <%= req.translations.verifiedStatus %>
          </label>
          <select
            id="userVerified"
            name="verified"
            class="w-full rounded-xl bg-neutral-800/40 border border-white/10 px-4 py-2 text-sm text-white focus:outline-none"
          >
            <option value="true"><%= req.translations.true %></option>
            <option value="false"><%= req.translations.false %></option>
          </select>
        </div>

      </div>

      <button
        id="createNodeBtn"
        type="button"
        class="rounded-xl <%= theme['button-color'] %> px-5 py-2 text-sm font-medium shadow transition"
      >
        <%= req.translations.create %>
      </button>

    </div>
  </div>

</main>
<script>
  document
    .getElementById("createButton")
    .addEventListener("click", function () {
      var table = document.getElementById("nodeTable");
      var form = document.getElementById("nodeForm");
      if (table.style.display !== "none") {
        table.style.display = "none";
        form.style.display = "block";
      } else {
        table.style.display = "block";
        form.style.display = "none";
      }
    });
</script>
<script>
  document
    .getElementById("createNodeBtn")
    .addEventListener("click", function () {
      const username = document.getElementById("userName").value;
      const email = document.getElementById("email").value;
      const password = document.getElementById("userPass").value;
      const adminString = document.getElementById("userAdmin").value;
      const admin = adminString === "true";

      const nodeData = {
        username,
        email,
        password,
        admin,
        verified: false,
      };

      console.log(nodeData);

      fetch("/users/create", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(nodeData),
      })
        .then((response) => {
          if (response.ok) {
            return response.json();
          }
          throw new Error("Failed to create user");
        })
        .then((data) => {
          console.log("user created:", data);
          alert('<%= req.translations.userCreatedSuccess %>');
          window.location.reload();
        })
        .catch((error) =>
          alert('<%= req.translations.userCreateError %>: ' + error.message)
        );
    });
</script>
<!-- remove -->
<script>
  document.querySelectorAll('.removeButton').forEach(button => {
    button.addEventListener('click', function() {
      const userId = this.dataset.userId;
      const totalUsers = document.querySelectorAll('.removeButton').length;
      if (totalUsers === 1) {
        alert('<%= req.translations.databaseCannotDelete %>');
        return;
      }
      const currentUserId = '<%= user.userId %>';
      if (userId === currentUserId) {
        alert('<%= req.translations.userCannotDelete %>');
        return;
      }
      const confirmation = confirm('<%= req.translations.userDeletingConfirmation %>');
      if (!confirmation) return;

      fetch('/user/delete', {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ userId })
      })
      .then(response => {
        if (response.ok) {
          window.location.reload();
        } else {
          throw new Error('Failed to delete user');
        }
      })
      .catch(error => alert('<%= req.translations.userDeletingError %>' + error.message));
    });
  });
</script>

<%- include('../components/footer') %>
